<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="../style/styleVisaoEspecifica.css">
</head>

<body>
    <header>
        <h1 id="h1_pc"></h1>
    </header>
    <div class="side-menu">
        <div class="perfil">
            <div class="foto-perfil">
                <div class="a"></div>
            </div>
            <div class="nome-perfil">
                <p id="nome"></p>
            </div>
        </div>
        <div class="menu-lateral">
            <div onclick="window.location = 'index.html'" class="botao">
                <p >Home</p>
            </div>
            <div onclick="window.location = 'visaoGeral.html'" class="botao">
                <p >Visão Geral</p>
            </div>
            <div onclick="window.location = 'todosPCs.html'" class="botao">
                <p >Visão Específica</p>
            </div>
            <div class="botao">
                <p>Editar Perfil</p>
            </div>
        </div>
        <div class="botoes-perfil">
            <div id="add_user" class="botao" onclick="window.location = 'novoUser.html'">
                <p>Adcionar Usuário</p>
            </div>
            <div onclick="sair()" class="botao">
                <p>Sair</p>
            </div>
        </div>
    </div>
    <main>
        <div class="content">
            <div class="titulo">
                <p>Visão Específica</p>
            </div>
            <div class="indicadores">
                <div class="indicador">
                    <p>Quantidade de alertas registrados nas ultimas 24 horas: 12</p>
                </div>
                <div class="indicador">
                    <p>Ultimo alerta: 13/11/2023 13:32:26 (Alta temperatura)</p>
                </div>
                <div class="indicador">
                    <p>Componente que mais gerou alertas nas últimas 24 horas: Memória (7)</p>
                </div>
                <div class="indicador">
                    <p>Status: revisão recomendada!</p>
                </div>
            </div>
            <div class="dashboard">
                <div class="graficos">
                    <div class="grafico">
                        <div class="title">Uso de ram em tempo real</div>
                        <canvas id="myChart1"></canvas>
                    </div>
                    <div class="grafico">
                        <div class="title">Uso de processador em tempo real</div>
                        <canvas id="myChart2"></canvas>
                    </div>
                </div>
                <div class="graficos">
                    <div class="grafico">
                        <div class="title">Uso de disco em tempo real</div>
                        <canvas id="myChart3"></canvas>
                    </div>
                    <div class="grafico">
                        <div class="title">Temperatura em tempo real (ºC)</div>
                        <canvas id="myChart4"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </main>
</body>

</html>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


<script>
    if(sessionStorage.TIPO_USUARIO == 'colab'){
        document.getElementById('add_user').style.display = 'none'
    }

    document.getElementById('h1_pc').innerHTML = sessionStorage.NOME_PC;
    document.getElementById('nome').innerHTML = sessionStorage.NOME_USUARIO + ' ' + sessionStorage.SOBRENOME_USUARIO

    window.onload = obterDadosPc(sessionStorage.ID_PC)

    function obterDadosPc(idComputador) {

        // if (proximaAtualizacao != undefined) {
        //   clearTimeout(proximaAtualizacao);
        // }

        fetch(`/status/especifico/${idComputador}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    resposta.reverse();
                    plotarGrafico('memoria', '% Uso de RAM', resposta, 1);
                    plotarGrafico('processador', '% Uso de CPU', resposta, 2);
                    plotarGrafico('disco', '% Uso de Disco', resposta, 3);
                    plotarGrafico('temp', 'Temperatura do processador', resposta, 4);

                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }


    function plotarGrafico(dado, legenda, resposta, idGrafico) {

        console.log('iniciando plotagem do gráfico...');

        // Criando estrutura para plotar gráfico - labels
        let labels = [];

        // Criando estrutura para plotar gráfico - dados
        let dados = {
            labels: labels,
            datasets: [{
                label: legenda,
                data: [],
                fill: true,
                borderColor: '#871bc69f',
                backgroundColor: '#871bc63f',
                tension: 0.3
            }]
        };

        console.log('----------------------------------------------')
        console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
        console.log(resposta)

        // Inserindo valores recebidos em estrutura para plotar o gráfico
        if (dado == 'memoria') {
            for (i = 0; i < resposta.length; i++) {
                var registro = resposta[i];
                labels.push(registro.dtHoraCaptura);
                dados.datasets[0].data.push(registro.memoria);
            }
        } else if (dado == 'processador') {
            for (i = 0; i < resposta.length; i++) {
                var registro = resposta[i];
                labels.push(registro.dtHoraCaptura);
                dados.datasets[0].data.push(registro.processador);
            }
        } else if (dado == 'disco') {
            for (i = 0; i < resposta.length; i++) {
                var registro = resposta[i];
                labels.push(registro.dtHoraCaptura);
                dados.datasets[0].data.push(registro.disco);
            }
        } else if (dado == 'temp') {
            for (i = 0; i < resposta.length; i++) {
                var registro = resposta[i];
                labels.push(registro.dtHoraCaptura);
                dados.datasets[0].data.push(registro.temp);
            }
        }

        console.log('----------------------------------------------')
        console.log('O gráfico será plotado com os respectivos valores:')
        console.log('Labels:')
        console.log(labels)
        console.log('Dados:')
        console.log(dados.datasets)
        console.log('----------------------------------------------')

        // Criando estrutura para plotar gráfico - config
        const config = {
            type: 'line',
            data: dados,
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        };

        // Adicionando gráfico criado em div na tela
        let myChart = new Chart(
            document.getElementById(`myChart${idGrafico}`),
            config
        );

        // setTimeout(() => atualizarGrafico(idAquario, dados, myChart), 2000);
    }

    function sair() {
        Swal.fire({
            position: 'center',
            icon: 'success',
            title: 'OK!',
            text: 'Saindo da sua conta...!',
            showConfirmButton: false,
            timer: 2000
        })
        sessionStorage.clear()
        setTimeout(function () {
            window.location = "../login.html"
        }, 2000);
    }
</script>